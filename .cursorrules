Always use IP instead of localhost
Never use port 3000 (reserved for MCP tools)
WordPress on port 8085; phpMyAdmin on 8086
All theme work inside `wp-content/themes/flexpress/`
Update `README.md` in project root and theme for any feature changes
Cache: Redis enabled; logged-in HTML private/no-store; add `Vary: Cookie`; never cache HTML via service worker
Use Puppeteer tests against the test site; prefer IPs for navigation and screenshots
PHP indent: 4 spaces; JS: 2 spaces; CSS: 2 spaces
Do not alter `.wakatime-project` once created
Bundled webfonts must use `font-display: swap`

## Model Hero Image Optimization (November 2025)

- Model hero uses a 12:5 aspect ratio (1920x800) with center crop across hero components.
- Model hero and profile images use Bunny Image Optimizer via `flexpress_get_bunnycdn_optimized_image_url()`.
- Hero images use width=1920, height=800 for center crop to maintain 12:5 ratio.
- CDN host comes from `bunnycdn_static_host`; default `static.zakspov.com`.

## Render Blocking Optimizations (November 2025)

- Critical above-the-fold rules live in `assets/css/critical.css` and are inlined via the `flexpress-critical-inline` handle; keep the file lean and ASCII-only.
- Blocking stylesheets are transformed into preload + `media="print"` swap tags by `flexpress_async_style_loader_tag()`; update the handle allowlist in `flexpress_get_async_style_handles()` when adding new global CSS bundles.
- `flexpress_preload_critical_resources()` only emits DNS hints—avoid reintroducing synchronous `<link rel="stylesheet">` output inside `wp_head`.
- `flexpress_maybe_dequeue_block_styles()` removes Gutenberg CSS when `flexpress_should_keep_block_styles()` reports no blocks; extend the helper if new block-based templates ship.
- jQuery runs deferred from the footer (`group` = 1); never inject inline head scripts that expect jQuery before the footer executes.
- Puppeteer coverage in `tests/puppeteer/test-critical-assets.mjs` asserts async CSS markup and script placement—keep it updated alongside enqueue changes.

## Service Worker Origin Constraint (November 2025)

- Service Worker file `wp-content/themes/flexpress/sw.js` must be served from the same origin as the page.
- Registration uses `get_template_directory_uri() . '/sw.js'` to ensure origin URL.
- Exclude `sw.js` from CDN rewrite/serving (Bunny CDN pull zone) to prevent cross-origin registration failures.
- Never cache HTML in the service worker. Static assets only.

## Settings Save Robustness Pattern

- All feature settings that share `flexpress_general_settings` MUST:
  - Use a merge sanitizer that preserves non-posted keys
  - Precede every checkbox input with a hidden `0` input of the same name
  - For array multi-selects, include a reset marker hidden input if needed
- Dedicated page slugs:
  - Awards → `flexpress_awards_settings`
  - Featured On → `flexpress_featured_on_settings`
  - Coming Soon → `flexpress_coming_soon_settings`
- Documentation: Update README.md when changing settings behavior

## FlowGuard Payment System Pattern

- **API Endpoint**: Single endpoint `https://flowguard.yoursafe.com/api/merchant` for both sandbox and production
- **No Environment Setting**: Removed sandbox/production toggle from WordPress settings since it doesn't change functionality
- **Configuration**: Manage test vs live through FlowGuard ControlCenter, not through WordPress
- **Credentials**: Same Shop ID and Signature Key work for both environments
- **Settings**: Only Shop ID and Signature Key needed in WordPress settings
- **Documentation**: Update README.md when modifying FlowGuard integration

## FlexPress Admin Menu Organization Pattern

- **Menu Structure**: Organized submenu structure under FlexPress main menu
  - General: Core site settings (logo, colors, site info)
  - Awards: Awards & Recognition section settings
  - Featured On: Media outlets and publications settings
  - Coming Soon: Maintenance mode settings
  - Pages & Menus: Page and menu management tools
  - Auto-Setup: Setup and configuration tools
  - Integrations: Discord, Turnstile, Plunk, SMTP, etc.
- **Settings Classes**: Each major feature has its own settings class
  - `FlexPress_Awards_Settings`: Awards & Recognition functionality
  - `FlexPress_Featured_On_Settings`: Featured On section management
  - `FlexPress_Coming_Soon_Settings`: Coming Soon mode configuration
- **Data Persistence**: All settings use `flexpress_general_settings` option for backward compatibility
- **Menu Registration**: Add submenu items in `class-flexpress-settings.php` using `add_submenu_page()`
- **Render Methods**: Each settings class has its own `render_*_settings_page()` method
- **Documentation**: Update README.md with new menu locations when reorganizing settings

## Coming Soon Mode Implementation Pattern

- Settings: Add to `class-flexpress-coming-soon-settings.php` with proper sanitization
- Template: Create dedicated template in `page-templates/` directory
- Redirect: Use `template_redirect` hook with priority 1 for early interception
- Admin bypass: Check `flexpress_current_user_is_founder()` before redirect
- Whitelist Logic: Check `is_page($whitelist_array)` before redirect for page exceptions
- Assets: Create dedicated CSS/JS files in `assets/` directory
- Helper Function: Use `flexpress_is_coming_soon_enabled()` to check status in templates
- Documentation: Update README.md and .cursorrules with feature details

## Casting Requirements Implementation Pattern

- Data Structure: Use JSON format in ACF textarea fields for structured content
- Template: Leverage existing template structure with conditional rendering
- Styling: Utilize existing CSS classes for consistent design
- Icons: Use FontAwesome classes for visual consistency
- Content Management: Store requirements in `casting_requirements_cards` ACF field
- JSON Format: `[{"icon_class": "fas fa-icon", "title": "Category", "requirements": ["item1", "item2"]}]`
- Documentation: Update README.md with feature details and technical implementation

## Collections Settings Implementation Pattern

- Settings: Add to new `class-flexpress-collections-settings.php` with proper sanitization
- Template: Create `collections.php` page template in `page-templates/` directory
- Redirect: Check `flexpress_collections_enabled()` at start of template to redirect `/collections` to `/episodes/` when disabled
- Admin Menu: Register "Collections" submenu under FlexPress main menu in `class-flexpress-settings.php`
- Helper Function: Use `flexpress_collections_enabled()` to check feature status throughout site
- Conditional UI: Wrap all collection-specific UI elements (badges, links, sections) with `if (flexpress_collections_enabled())` checks
- Settings Store: Use `flexpress_collections_settings` option for configuration
- Sanitization: Checkbox validation for enabled state, `sanitize_text_field()` for titles, `wp_kses_post()` for descriptions
- Default State: Collections disabled by default (must be explicitly enabled)
- Documentation: Update README.md and .cursorrules with enable/disable functionality

## Tag Collection System Implementation Pattern

- ACF Fields: Add collection metadata fields to `post_tag` taxonomy in `includes/acf-fields.php`
- Helper Functions: Create collection detection and metadata functions in `functions.php`
- Template: Create `tag.php` template with collection detection and enhanced layouts
- Styling: Add collection-specific CSS with gradients and animations in `main.css`
- Integration: Update episode archive filtering to show collection badges and direct links (when enabled)
- Navigation: Enhance single episode pages to show collection links with badges (conditional)
- Detection: Use `flexpress_is_collection_tag()` to check if tag is a collection
- Metadata: Use `flexpress_get_collection_metadata()` to get collection settings
- Ordering: Support newest, oldest, alphabetical, and custom episode ordering
- Conditional: Always check `flexpress_collections_enabled()` before displaying collection UI
- Documentation: Update README.md with collection system details and usage examples

## Featured Banner System Implementation Pattern

- Settings: Add to `class-flexpress-general-settings.php` with proper sanitization
- Template: Create dedicated template in `template-parts/` directory
- Integration: Add template part to homepage below featured episodes section
- Assets: Add CSS styles to `main.css` with hover effects and responsive design
- Media Uploader: Use WordPress media library with preview and remove functionality
- Sanitization: Use `absint()` for image IDs, `esc_url_raw()` for URLs, checkbox validation
- Accessibility: Include proper alt text, ARIA labels, and semantic HTML
- Responsive: Mobile-optimized with disabled hover effects on small screens
- Documentation: Update README.md with feature details and technical implementation

## Bootstrap 5 Form Checkbox Styling Pattern

- Problem: Bootstrap 5 checkboxes on dark themes don't show visible checkmarks and checkbox/label alignment issues
- Solution: Enhanced `.form-check` container and `.form-check-input` styling in `main.css`
- Technical Details:
  - Container: `.form-check` uses flexbox with `display: flex`, `align-items: flex-start`, `gap: 0.5rem`
  - Label: `.form-check-label` uses `flex: 1`, `line-height: 1.5`, `margin-bottom: 0`
  - Checkbox: `.form-check-input` uses `flex-shrink: 0`, `margin-top: 0.25rem`
  - Unchecked: `rgba(255, 255, 255, 0.1)` background, `rgba(255, 255, 255, 0.3)` border
  - Checked: Accent color background (`var(--color-accent)`) with white SVG checkmark
  - Checkmark: Data URI SVG (`data:image/svg+xml...`) with white stroke
  - Hover: Brighter border and background for better UX
  - Focus: Accent color glow using `box-shadow: 0 0 0 0.25rem var(--color-accent-light)`
  - Disabled: Opacity 0.5 with `cursor: not-allowed`
  - Contact Form 7: Special CSS for checkboxes wrapped in `<p>` tags: `.form-check p` uses flexbox, `.form-check p br` hidden
- Usage: Apply Bootstrap's `form-check`, `form-check-input`, and `form-check-label` classes
- Documentation: Update README.md with checkbox styling implementation details

## Subscription Type Labeling

- Use `flexpress_get_user_subscription_type($userId)` for all displays
- Labels: "Free Trial" (active trial), "membership" (active/cancelled until expiry), "none"
- Frontend: replace direct `subscription_type` meta usage with helper
- Admin: show derived label in membership panel; do not alter DB schema

## Free Trial Signup UX Pattern

- **Signup Text**: Free trial signups display termination messaging instead of auto-renewal
  - Text: "After the trial, your access will be terminated and you will be prompted to purchase access"
  - Update both JavaScript (dynamic plan selection) and PHP (trial link scenarios)
  - Files: `page-templates/join.php` and `page-templates/membership.php`
- **Alert Styling**: Free Trial Activated banner uses accent color
  - Class: `.alert-trial` with `.membership-page .alert-trial` for specificity
  - Background: `var(--color-accent)` with white text for contrast
  - Border-left: `var(--color-accent-hover)` for emphasis (4px solid)
  - Selector must match `.membership-page .alert` specificity to override defaults
- **Default Accent Color**: Theme default is pink (#ff5093) - rgb(255, 80, 147)
  - Updated in: `functions.php`, `class-flexpress-general-settings.php`, `assets/css/variables.css`
  - Auto-generates hover, light, and dark variants
- Documentation: Update README.md when changing signup flow or styling

## Founder Permissions Model

- Capability: Founders use `manage_flexpress_founder_settings`; grab it via `flexpress_get_founder_capability()` when registering menus or meta caps.
- Enforcement: Guard FlexPress settings pages, dashboards, AJAX, and REST handlers with `flexpress_current_user_is_founder()` or `flexpress_require_founder_capability()`.
- Founder Access: Treat founders as members/unlock purchasers by calling `flexpress_user_is_founder()` inside access checks.
- Management UI: Assign founders from `FlexPress → Permissions`; use `flexpress_set_founder_user_ids()` to persist selections and sync caps.
- Safeguard: Founders cannot remove themselves—demote via another founder to avoid lockouts (UI blocks self-removal).
