# Cursor Rules for FlexPress

- Always use IP instead of localhost
- Never use port 3000 (reserved for MCP tools)
- WordPress on port 8085; phpMyAdmin on 8086
- All theme work inside `wp-content/themes/flexpress/`
- Update `README.md` in project root and theme for any feature changes
- Cache: Redis enabled; logged-in HTML private/no-store; add `Vary: Cookie`; never cache HTML via service worker
- Use Puppeteer tests against the test site; prefer IPs for navigation and screenshots
- PHP indent: 4 spaces; JS: 2 spaces; CSS: 2 spaces
- Do not alter `.wakatime-project` once created

## Recent Fixes

### Episode Admin Columns (Oct 2025)

- Renamed "Episode Status" column to "Access Type" in episodes admin list
- Access Type now displays ACF field value (not taxonomy) with color-coded badges
- Badge colors: Free (cyan), Membership Only (blue), PPV Only (yellow), Membership+PPV (green), Members Discount (purple)
- Removed "Video Preview" column from episodes admin list
- Retained columns: Title, Tags, Access Type, Date
- Access Type column is sortable
- Video thumbnails still visible when editing individual episodes

### Date Format Standardization (Oct 2025)

- All episode dates now display in Australian/European format (day-first)
- Full format: "9 November 2025" (`j F Y`)
- Abbreviated format: "9 Nov 2025" (`j M Y`)
- With time: "9 November 2025 at 12:01 PM" (`j F Y \a\t g:i A`)
- Standardized across: single episode pages, episode cards, extras cards, coming soon badges
- Removed American format (month-first) for consistency
- Fixed ACF date parsing: European format dates (dd/mm/yyyy) are now correctly interpreted instead of being misread as American format (mm/dd/yyyy)
- Added date parsing logic to all episode templates to handle European date format from ACF fields
- Fixed `flexpress_is_episode_released()` function to properly parse European dates for auto-publishing
- Episodes with past release dates now correctly auto-publish when saved (previously remained in Draft due to date misinterpretation)

### Earnings Dashboard (Oct 2025)

- Comprehensive revenue tracking in FlexPress → Earnings admin tab
- Real-time statistics: gross revenue, net revenue (after commissions), transaction counts
- Transaction type breakdown: subscriptions, rebills, PPV unlocks, refunds, chargebacks
- Time period filtering: today, last 7 days, last 30 days, last year, custom date range
- Interactive Chart.js visualizations: revenue over time, transaction distribution, gross vs net comparison
- Detailed transaction table with user info, amounts, and status
- CSV export functionality for all time periods with complete transaction data
- Automatic affiliate commission deduction from gross to calculate net revenue
- Cross-references `wp_flexpress_flowguard_transactions`, `wp_flexpress_flowguard_webhooks`, and `wp_flexpress_affiliate_transactions` tables

### Episode Release Date Sync (Oct 2025)

- ACF `release_date` is the source of truth
- `post_date` updates only when `release_date` changes
- Non-ACF saves (e.g., tags) do not overwrite the release date
- One-time tool available: FlexPress → Tools → Sync Episode Dates (`acf_to_wp`)

## Recent Fixes (Dec 2024)

### Extras Post Type Issues Fixed

- Fixed post overwriting bug: Gallery uploads now use correct post ID (`$post->ID` instead of `get_the_ID()`)
  - Added `global $post;` declaration to `enqueue_admin_scripts()` function
  - Added autosave protection to `save_gallery_data()` function
- Fixed gallery grid display: Added missing CSS styles to `render_extras_gallery_meta_box()` function
- Gallery images now display in proper grid layout instead of vertical list

## Model Profiles – Manual Age & Separate Measurements (Oct 2025)

- Age is manual-only (`model_published_age`); do not calculate from DOB
- Separate fields: `model_location`, `model_weight`, `model_bra_size`, `model_bust`, `model_waist`, `model_hips`
- Legacy `model_measurements` retained under Legacy tab; not displayed
- Render order in `single-model.php`: Published Age, Location, Height, Weight, Bra Size, Bust, Waist, Hips

## Episode Gallery Sort Order (Jan 2025)

- Episode galleries automatically sort by filename with numeric sequence extraction
- Handles numbered filenames (001, 002, 003, etc.) with proper numeric sorting
- Images without numbers fall back to alphabetical filename sorting
- Sorting applied both on upload (`ajax_upload_gallery_image()`) and display (`flexpress_display_episode_gallery()`)
- Migration script available: `scripts/sort-existing-galleries.php` (safe to run multiple times)
- Gallery images now include `filename` field for consistent sorting

## Gallery Upload Reliability (Jan 2025)

- Sequential uploads prevent race conditions and server overload (no more parallel uploads)
- Per-file progress tracking with status indicators (pending, uploading, success, failed)
- Automatic retry for failed uploads plus manual retry buttons
- Enhanced error handling with specific error messages and codes
- Increased timeout to 120 seconds per individual upload
- Upload queue management prevents multiple simultaneous upload sessions
- Detailed progress UI shows filename, size, status, and progress bars

## Unpublished Episode Handling (Oct 2025)

- Episodes with future `release_date` automatically set to `post_status = 'draft'`
- Draft episodes hidden from logged-out users (redirected to login if accessed directly)
- Logged-in users can see draft episodes with "Coming Soon" indicators
- Unreleased episodes show trailer video only (never full video, regardless of access)
- Visual indicators: alert banner, coming soon badge overlay, disabled purchase buttons
- Auto-publishes when `release_date` passes (handled by ACF save_post hook)
- Query filtering: logged-out users see only published; logged-in see published + draft

## Pricing Plans – Verotel Compliance (Oct 2025)

- Trial periods must be minimum 3 days (Verotel requirement)
- Frontend validation prevents creation of trials < 3 days when unit is "days"
- Backend validation enforces 3-day minimum on save
- Monthly trials have minimum of 1 month (no restriction)
- HTML input field has dynamic `min` attribute based on selected duration unit
- Error message: "Trial period must be at least 3 days (Verotel requirement)"
