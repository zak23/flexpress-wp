# Caddyfile for FlexPress WordPress Site
# This configuration adds proper caching headers for WordPress detection

zakspov.com {
    reverse_proxy 192.168.1.238:8085 {
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # Increase timeouts for cold starts
        transport http {
            dial_timeout 30s
            response_header_timeout 60s
            expect_continue_timeout 10s
            keepalive 90s
            keepalive_idle_conns 10
        }
    }

    # Add caching headers that WordPress expects to see
    header {
        # Cache-Control header for static assets
        Cache-Control "public, max-age=31536000" {
            path *.css
            path *.js
            path *.png
            path *.jpg
            path *.jpeg
            path *.gif
            path *.webp
            path *.svg
            path *.woff
            path *.woff2
            path *.ttf
            path *.eot
        }

        # Expires header for static assets (1 year from now)
        # Note: Caddy doesn't support dynamic date calculation, so we use a fixed future date
        # This is set to expire in 1 year from configuration time
        Expires "Thu, 31 Dec 2026 23:59:59 GMT" {
            path *.css
            path *.js
            path *.png
            path *.jpg
            path *.jpeg
            path *.gif
            path *.webp
            path *.svg
            path *.woff
            path *.woff2
            path *.ttf
            path *.eot
        }

        # NOTE: Do not cache HTML globally; admin/logged-in responses are explicitly bypassed below

        # Add ETag header for better caching
        ETag {http.response.header.content-length}

        # Add Last-Modified header
        Last-Modified {http.response.header.date}

        # Add Age header (calculated by Caddy)
        Age {http.response.header.age}

        # Custom headers that WordPress caching plugins often use
        X-Cache-Enabled "true"
        X-Cache-Status "HIT"

        # Remove server signature for security
        -Server
    }

    # No-cache for admin, REST, login, and AJAX endpoints
    @noCacheAdmin {
        path /wp-admin/*
        path /wp-login.php
        path /wp-cron.php
        path /wp-json/*
        path /xmlrpc.php
        path /wp-admin/admin-ajax.php
    }
    header @noCacheAdmin {
        Cache-Control "private, no-store, max-age=0"
        Pragma "no-cache"
        Vary "Cookie"
        X-Cache-Status "BYPASS"
        -Server
    }

    # No-cache for any request with a logged-in cookie
    @loggedin header_regexp LoggedIn Cookie (wordpress_logged_in_|wordpress_sec_)
    header @loggedin {
        Cache-Control "private, no-store, max-age=0"
        Pragma "no-cache"
        Vary "Cookie"
        X-Cache-Status "BYPASS"
        -Server
    }

    # Enable gzip compression for all compressible content types
    # Caddy automatically compresses: text/html, text/css, text/javascript, 
    # application/javascript, application/json, text/xml, application/xml, image/svg+xml
    encode gzip

    # Security headers
    header {
        # Security headers
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"

        # Remove server signature
        -Server
    }

    # Logging
    log {
        output file /var/log/caddy/flexpress.log
        format json
    }
}

# Redirect www to non-www
www.zakspov.com {
    redir https://zakspov.com{uri} permanent
}
